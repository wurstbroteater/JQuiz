{% extends "leaderboard/leaderboard_base.html" %}

{% block title %}Your Profile{% endblock %}

{% block content %}
    <style>
        .quiz-header {
            padding: 10px;
            margin-bottom: 5px;
            border: 1px solid #a9b7c6;
        }

        .quiz-content {
            margin-bottom: 20px;
        }
    </style>

    <script>
        function toggleQuiz(element) {
            const content = element.nextElementSibling;
            if (content.style.display === "none") {
                content.style.display = "block";
            } else {
                content.style.display = "none";
            }
        }

        function deletePendingTurns(e) {
            e.preventDefault();
            if (confirm("Are you sure you want to delete all incomplete quizzes?")) {
                fetch("{% url 'delete_incomplete_turns' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert("Failed to delete incomplete quizzes.");
                    }
                });
            }
        }
    </script>

    <h1>Your Profile, {{ user.username }}</h1>
    <p>Email: {{ user.email }}</p>
    <ul>
        <li><a href="{% url 'update_email' %}">Change Email</a></li>
        <li><a href="{% url 'delete_account' %}">Delete Account</a></li>
        <li><a href="{% url 'change_password' %}">Change Password</a></li>
        {% if pending_turns > 0 %}
            <li>
                <a href="#" id="delete-incomplete-link"
                   style="background-color: yellowgreen;"
                   onclick="deletePendingTurns(event)">Delete {{ pending_turns }} Pending Turn{% if pending_turns != 1 %}s{% endif %}</a>
            </li>
        {% endif %}
    </ul>

    <h2>Your Progress</h2>
    <div id="leaderboard">
        {% for quiz_data in data %}
            <div class="quiz-item">
                <h3 class="quiz-header" onclick="toggleQuiz(this)">
                    {{ quiz_data.quiz }}
                </h3>
                <div class="quiz-content" style="display: none;">
                    <table>
                        <thead>
                        <tr>
                            <th>Correct</th>
                            <th>Completed</th>
                            <th>Best Score</th>
                            <th>Average Score</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for score in quiz_data.data %}
                            <tr>
                                <td>{{ score.correct_turns }}</td>
                                <td>{{ score.completed_turns }}</td>
                                <td>
                                    <div class="progress-bar">
                                        <div class="progress"
                                             style="width: {{ score.best_score }}%;">{{ score.best_score }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="progress-bar">
                                        <div class="progress"
                                             style="width: {{ score.average_score }}%;">{{ score.average_score }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="4">No Personal Progress</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endfor %}
    </div>
{% endblock %}
